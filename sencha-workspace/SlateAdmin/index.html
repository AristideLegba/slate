<!DOCTYPE html>
<html manifest="">
    <head>
        <title>Loading&hellip;</title>
    </head>
    <body>
        <script>
        (() => {
            const [,apiHost] = location.search.match(/[?&]apiHost=([^&]+)/) || [];

            if (!apiHost) {
                document.body.innerHTML = 'Page must be loaded with <code>?apiHost=slate.example.org</code> set'
                return;
            }

            const xhr = new XMLHttpRequest();
            xhr.responseType = 'document';
            xhr.withCredentials = true;
            xhr.open('GET', `http://${apiHost}/manage`);
            xhr.onload = () => {
                if (xhr.status === 200) {
                    // graft head elements
                    xhr.response
                        .querySelectorAll('head > *:not([href^="/webapps/"])')
                        .forEach(node => {
                            // capture full hrefs from source document
                            if (node.href) {
                                node.href = node.href;
                            }
                            document.head.appendChild(node);
                        });

                    // graft body elements
                    xhr.response
                        .querySelectorAll('body > *:not([src^="/webapps/"])')
                        .forEach(node => {
                            // skip manifest-patching script
                            if (node.nodeName == 'SCRIPT') {
                                if (node.text.match(/^\s*Ext\.manifest\.resources\.path\s*=/)) {
                                    return;
                                }
                            } else {
                                // capture full hrefs/srcs from source document
                                node.querySelectorAll('[src]').forEach(srcNode => {
                                    srcNode.src = srcNode.src;
                                });
                                node.querySelectorAll('[href]').forEach(hrefNode => {
                                    hrefNode.href = hrefNode.href;

                                    if (hrefNode.nodeName == 'A') {
                                        hrefNode.target = '_blank';
                                    }
                                });

                                const externalSvgQueue = new Set();
                                node.querySelectorAll('svg').forEach(svgNode => {
                                    svgNode.querySelectorAll('use').forEach(svgUseNode => {
                                        const [svgPath, svgHash] = svgUseNode.href.baseVal.split('#', 2);

                                        externalSvgQueue.add(`http://${apiHost}${svgPath}`);

                                        const newUseNode = document.createElementNS('http://www.w3.org/2000/svg', 'use');
                                        newUseNode.setAttribute('href', `#${svgHash}`);
                                        svgNode.replaceChild(newUseNode, svgUseNode);
                                    });
                                });

                                // load all external SVGs
                                for (const svgUrl of externalSvgQueue) {
                                    const svgXhr = new XMLHttpRequest();
                                    svgXhr.responseType = 'document';
                                    svgXhr.withCredentials = true;
                                    svgXhr.open('GET', svgUrl);
                                    svgXhr.onload = () => {
                                        if (svgXhr.status === 200) {
                                            document.body.appendChild(svgXhr.response.firstChild);
                                        }
                                    };
                                    svgXhr.send();
                                }
                            }
                            document.body.appendChild(node);
                        });

                    // finally: load app
                    const appScript = document.createElement('script');
                    appScript.setAttribute('id', 'microloader');
                    appScript.setAttribute('data-app', 'e21d2a04-1fe0-4793-a299-186188656a28');
                    appScript.setAttribute('type', 'text/javascript');
                    appScript.setAttribute('src', 'bootstrap.js');
                    document.body.appendChild(appScript);
                } else {
                    console.error('could not load page frame from apiHost, got status=%o', xhr.status);
                }
            };
            xhr.send();
        })();
        </script>
    </body>
</html>